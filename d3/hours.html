<!DOCTYPE html>
<meta charset="utf-8">
<title>bike stations</title>
<meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

<style>

body {
  margin: 0;
  background: #222;
  min-width: 600px;
  font-family: Helvetica, Arial, Sans-Serif;
  color: #aaa;
  font-size: 15px;
}

#content {
  margin: 50px;
}

#tooltip {
	font-size: 24px;
	color: #fff;
	font-family: Helvetica, Arial, Sans-Serif;
	background: rgba(30,30,30,0.5);
	color: #f0f0f0;
	padding: 5px;
	max-width: 250px;
	font-size: 12px;
	position: absolute;
	z-index: 100666;
}

.dayLabel {
  font-size: 16px;
  text-fill: #aaa;
}

</style>
<body>
<div id="content"></div>
<script src="d3.min.js"></script>

<script>

var format = d3.time.format("%Y-%m-%d");
var seasonStart = format.parse("2015-05-01");
var totalStations = 0;
console.log(seasonStart);

//var dayNames = ['Sunday', 'Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
//var dayNames = ['Воскресенье', 'Понедельник','Вторник','Среда','Четверг','Пятница','Суббота'];

var width = 1000, height = 1000;
var body = d3.select("body");

var hourWidth = 0.5, hourOpacity = 0.5;
var dayWidth = 0.7, dayOpacity = 1;
var offset = 300, scale = 0.95;
var tooltip = body.append("div")
	.style("visibility", "hidden")
	.attr("id", "tooltip")
	.text("");

//var format

var svg = d3.select("#content").append("svg")
    .attr("width", width)
    .attr("height", height);

//setting the area
var axes = svg.append("svg:g")
	.attr("width", width)
	.attr("height", height)
	.attr("id", "axes");

var rect = svg.append("svg:g")
	.attr("width", width)
	.attr("height", height)
	.attr("id", "rect");

  var labels = svg.append("svg:g")
  	.attr("width", width)
  	.attr("height", height)
  	.attr("id", "labels");

  var lineHours = d3.svg.line()
          .x(function(d,i) {
            var ang = (360*(i/24))*(Math.PI/180);
            return offset+Math.cos(ang)*(d*scale);
            })
          .y(function(d,i) {
            var ang = (360*(i/24))*(Math.PI/180);
            return offset+Math.sin(ang)*(d*scale);
          })
          .interpolate("linear");


    var lineDays = d3.svg.line()
        .x(function(d,i) {
          var ang = (360*(i/24))*(Math.PI/180);
          return offset+Math.cos(ang)*(d*scale);
        })
        .y(function(d,i) {
          var ang = (360*(i/24))*(Math.PI/180);
          return offset+Math.sin(ang)*(d*scale);
        })
        .interpolate("linear");



//x1="0" y1="0" x2="0" y2="0"


//loading roads layer
d3.json("stations_all.json", function(json) {
  console.log(json);

  for(h = 0; h < 24; h++) {
    var ang = (360*((h)/24))*(Math.PI/180);
    x = offset+Math.cos(ang)*(offset*scale);
    y = offset+Math.sin(ang)*(offset*scale);

    axes.append("svg:line")
      .attr("fill", "none")
      .style("stroke", "#ffffff")
      .style("opacity", 0.5)
      .style("stroke-width", 1)
      .attr("x1", offset)
      .attr("y1", offset)
      .attr("x2", x)
      .attr("y2", y);

    labels.append("svg:text")
      .style("fill", "#a0a0a0")
      .attr("class", "dayLabel")
      .text(h)
      .attr("x", x)
      .attr("y", y)
      .attr("dx", -15)
      .attr("dy", 0);

    //svg:text x="0" y="0" dx="0" dy="0" text-anchor="start"



  }

  json.forEach(function(d,i) {

    if(d.departures > 1000) {
    var hours = d.hours,
        days = d.days,
        totalFare = [], dayFare = [], monthFare = [], seasonFare = [];


    hours.forEach(function(s,i) {
      totalFare.push(offset*scale);
      dayFare.push(Math.round(s.d/s.t*offset*scale));
      monthFare.push(Math.round(s.m/s.t*offset*scale));
      seasonFare.push(Math.round(s.s/s.t*offset*scale));
    });



    rect.append("svg:path")
        .attr("fill", "none")
        .style("stroke", "#aaa")
        .style("opacity", hourOpacity)
        .style("stroke-width", hourWidth)
        .attr("d", function(d) { return lineHours(totalFare) + "Z"; });

    rect.append("svg:path")
        .attr("fill", "none")
        .style("stroke", "#00aaff")
        .style("opacity", hourOpacity*1.2)
        .style("stroke-width", hourWidth*1.2)
        .attr("d", function(d) { return lineHours(dayFare) + "Z"; })
        .on('mousemove', function(e) {
          //target.style("opacity", 1);
          //target.style("stroke-width", 1)
        });

    rect.append("svg:path")
        .attr("fill", "none")
        .style("stroke", "#ff00CC")
        .style("opacity", hourOpacity)
        .style("stroke-width", hourWidth)
        .attr("d", function(d) { return lineHours(monthFare) + "Z"; });

    rect.append("svg:path")
        .attr("fill", "none")
        .style("stroke", "#ff7500")
        .style("opacity", hourOpacity)
        .style("stroke-width", hourWidth)
        .attr("d", function(d) { return lineHours(seasonFare) + "Z"; });
    }
  });

	});

</script>
</body>
</html>
